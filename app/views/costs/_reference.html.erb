<%- income = cost.income -%>
<div class="panel panel-info">
  <div class="panel-heading">
    <div class="row">
      <div class="col-md-2">
        <strong><%= Income.human_attribute_name(:code) %> : </strong><%= income.code %>
      </div>
      <div class="col-md-4">
        <strong><%= Income.human_attribute_name(:payer) %> : </strong><%= income.payer.name %>
      </div>
      <div class="col-md-3">
        <strong><%= Income.human_attribute_name(:income_amount) %> : </strong><%= income.income_amount %>
      </div>
      <div class="col-md-3">
        <strong><%= Income.human_attribute_name(:actual_amount) %> : </strong><%= income.actual_amount %>
        <span class="pull-right toggle_switch fold"><span class="glyphicon glyphicon-chevron-down"></span></span>
      </div>
    </div>
  </div>
  <div class="panel-body toggle_display">
    <%= render 'incomes/readonly_form', income: income %>
  </div>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th><%= Cost.human_attribute_name(:sn) %></th>
        <th><%= Cost.human_attribute_name(:payee) %></th>
        <th><%= Cost.human_attribute_name(:invoice_amount) %></th>
        <th><%= Cost.human_attribute_name(:paid_amount) %></th>
        <th><%= Cost.human_attribute_name(:unpaid_amount) %></th>
      </tr>
    </thead>
    <tbody>
      <% income.costs.each do |cost| %>
        <tr class="clickableRow">
          <td><%= link_to cost.sn, cost_path(cost.id) %></td>
          <td><%= cost.payee.brief_name %></td>
          <td class="invoice_amount"><%= cost.invoice_amount %></td>
          <td class="cost_amount"><%= cost.cost_amount %></td>
          <td class="unpaid_amount"><%= cost.unpaid_amount %></td>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr>
        <th colspan="2"><%= t(".summary") %></th>
        <td id="invoice_sum"></td>
        <td id="cost_sum"></td>
        <td id="unpaid_sum"></td>
      </tr>
      <tr>
        <th colspan="2"><%= Income.human_attribute_name(:available_amount) %></th>
        <td id="income_available_amount"><%= income.income_available_amount %></td>
        <td id="actual_available_amount"><%= income.actual_available_amount %></td>
        <td> —— </td>
      </tr>
    </tfoot>
  </table>
</div>


<script type="text/javascript">
function parseFix(value) {
  return parseFloat(value).toFixed(2);
}

function summary(amounts) {
  var sum = 0;
  amounts.each(function() {
    amount = parseFloat($(this).html());
    if (!isNaN(amount)) sum += amount;
  });
  return sum;
}

function summary_costs() {
  $("#invoice_sum").html(summary($(".invoice_amount")));
  $("#cost_sum").html(summary($(".cost_amount")));
  $("#unpaid_sum").html(summary($(".unpaid_amount")));
}

function parseCurrency(td) {
  amount = parseFloat(td.html());
  return isNaN(amount) ? 0.00 : amount;
}

function changeClassToDanger(ele) {
  ele.removeClass("success");
  ele.addClass("danger");
}

function changeClassToSuccess(ele) {
  ele.removeClass("danger");
  ele.addClass("success");
}

function mark_overflow() {
  invoice_sum = parseCurrency($("#invoice_sum"));
  income_available_amount = parseCurrency($("#income_available_amount"));
  if(invoice_sum > income_available_amount) {
    changeClassToDanger($("#invoice_sum"));
    changeClassToDanger($("#income_available_amount"));
  } else {
    changeClassToSuccess($("#invoice_sum"));
    changeClassToSuccess($("#income_available_amount"));
  }

  cost_sum = parseCurrency($("#cost_sum"));
  actual_available_amount = parseCurrency($("#actual_available_amount"));
  if(cost_sum > actual_available_amount) {
    changeClassToDanger($("#cost_sum"));
    changeClassToDanger($("#actual_available_amount"));
  } else {
    changeClassToSuccess($("#cost_sum"));
    changeClassToSuccess($("#actual_available_amount"));
  }
}


$(document).ready(function(){
    summary_costs();
    mark_overflow();
});
</script>